<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Embedded Sender With Form And First Signer - SignNow Sample</title>
    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/styles.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
</head>
<body>
<div class="header">
    <img src="/img/sign-now.png" alt="Logo">
</div>

<!-- Form Page -->
<div id="form-page" class="container-block">
    <h4>Enter Signer Information</h4>
    <form id="signer-form">
        <div class="sn-input-group mb-3">
            <label for="name">Name <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="name" name="name" required>
        </div>
        <div class="sn-input-group mb-3">
            <label for="email">Email <span class="text-danger">*</span></label>
            <input type="email" class="form-control" id="email" name="email" required>
        </div>
        <button type="submit" class="button-primary" id="submit-btn">
            Continue
        </button>
        <button type="button" class="btn btn-dark d-none" id="loading-btn" disabled>
            <span class="spinner-border spinner-border-sm me-2"></span>
            Processing...
        </button>
    </form>
</div>

<!-- Signing Page -->
<div id="signing-page" class="container-block" style="display: none;">
    <h4>Document Signing</h4>
    <div id="signing-content">
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Preparing signing interface...</p>
        </div>
    </div>
</div>

<!-- Status Page -->
<div id="status-page" class="container-block" style="display: none;">
    <h4>Document Status & Final Document</h4>
    <p>You can check signing status and download the completed document here.</p>

    <div id="no-recipients-container" class="no-recipients" style="display: none;">
        <div class="thank-you-message">
            <img src="/img/no-recipients.svg" alt="signNow" class="mb-3" />
            <h4>No signers found</h4>
            <p class="mb-4">
                No signers have been added to this document group yet.
            </p>
        </div>
    </div>

    <ul class="status-list" id="documentList"></ul>
</div>

<script>
    function getQueryParam(key) {
        const params = new URLSearchParams(window.location.search);
        return params.get(key) || '';
    }

    async function handlePages(pagesMap, defaultKey) {
        const fallbackKey = defaultKey || Object.keys(pagesMap)[0];
        const pageParam = new URLSearchParams(window.location.search).get('page') || fallbackKey;

        Object.keys(pagesMap).forEach(id => {
            const el = document.getElementById(id);
            if (el) el.style.display = 'none';
        });

        const handlerKey = pagesMap[pageParam] ? pageParam : fallbackKey;
        const handler = pagesMap[handlerKey];
        const el = document.getElementById(handlerKey);

        if (el) el.style.display = 'block';
        if (typeof handler === 'function') {
            await handler(el);
        } else {
            console.warn(`Handler for "${handlerKey}" not found or not a function.`);
        }
    }

    async function initFormPage() {
        const form = document.getElementById('signer-form');
        const submitBtn = document.getElementById('submit-btn');
        const loadingBtn = document.getElementById('loading-btn');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(form);
            const data = {
                action: 'prepare_dg',
                name: formData.get('name'),
                email: formData.get('email')
            };

            submitBtn.classList.add('d-none');
            loadingBtn.classList.remove('d-none');

            try {
                const response = await fetch('/api/samples/EmbeddedSenderWithFormAndFirstSigner', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    // Redirect to embedded sending URL
                    window.location.href = result.embedded_url;
                } else {
                    alert('Error: ' + result.message);
                    submitBtn.classList.remove('d-none');
                    loadingBtn.classList.add('d-none');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while processing your request.');
                submitBtn.classList.remove('d-none');
                loadingBtn.classList.add('d-none');
            }
        });
    }

    async function initSigningPage() {
        const documentGroupId = getQueryParam('document_group_id');
        
        if (!documentGroupId) {
            document.getElementById('signing-content').innerHTML = 
                '<div class="alert alert-danger">No document group ID provided.</div>';
            return;
        }

        try {
            const response = await fetch('/api/samples/EmbeddedSenderWithFormAndFirstSigner', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    action: 'create_signing_url',
                    document_group_id: documentGroupId
                })
            });

            const result = await response.json();

            if (result.success) {
                // Redirect to signing URL
                window.location.href = result.signing_url;
            } else {
                document.getElementById('signing-content').innerHTML = 
                    '<div class="alert alert-danger">Error: ' + result.message + '</div>';
            }
        } catch (error) {
            console.error('Error:', error);
            document.getElementById('signing-content').innerHTML = 
                '<div class="alert alert-danger">An error occurred while preparing the signing interface.</div>';
        }
    }

    async function initStatusPage() {
        const documentGroupId = getQueryParam('document_group_id');
        
        if (!documentGroupId) {
            document.getElementById('status-page').innerHTML = 
                '<div class="alert alert-danger">No document group ID provided.</div>';
            return;
        }

        try {
            const response = await fetch('/api/samples/EmbeddedSenderWithFormAndFirstSigner', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    action: 'invite-status',
                    document_group_id: documentGroupId
                })
            });

            const signers = await response.json();
            displaySigners(signers, documentGroupId);
        } catch (error) {
            console.error('Error:', error);
            document.getElementById('status-page').innerHTML = 
                '<div class="alert alert-danger">An error occurred while loading the status.</div>';
        }
    }

    function displaySigners(signers, documentGroupId) {
        const documentList = document.getElementById('documentList');
        const noRecipientsContainer = document.getElementById('no-recipients-container');

        if (!signers || signers.length === 0) {
            noRecipientsContainer.style.display = 'block';
            documentList.innerHTML = '';
            return;
        }

        noRecipientsContainer.style.display = 'none';
        
        let html = '';
        signers.forEach((signer, index) => {
            const statusClass = getStatusClass(signer.status);
            const statusText = getStatusText(signer.status);
            
            html += `
                <li class="status-item">
                    <div class="status-header">
                        <span class="signer-name">${signer.name}</span>
                        <span class="status-badge ${statusClass}">${statusText}</span>
                    </div>
                    <div class="signer-details">
                        <p><strong>Email:</strong> ${signer.email}</p>
                        <p><strong>Order:</strong> ${signer.order}</p>
                        ${signer.timestamp ? `<p><strong>Signed:</strong> ${new Date(signer.timestamp).toLocaleString()}</p>` : ''}
                    </div>
                </li>
            `;
        });

        // Add download button if any signer has completed
        const hasCompleted = signers.some(signer => signer.status === 'completed');
        if (hasCompleted) {
            html += `
                <li class="status-item">
                    <div class="download-section">
                        <button class="btn btn-primary" onclick="downloadDocument('${documentGroupId}')">
                            Download Completed Document
                        </button>
                    </div>
                </li>
            `;
        }

        documentList.innerHTML = html;
    }

    function getStatusClass(status) {
        switch (status) {
            case 'completed': return 'status-completed';
            case 'pending': return 'status-pending';
            case 'not_invited': return 'status-not-invited';
            default: return 'status-unknown';
        }
    }

    function getStatusText(status) {
        switch (status) {
            case 'completed': return 'Completed';
            case 'pending': return 'Pending';
            case 'not_invited': return 'Not Invited';
            default: return 'Unknown';
        }
    }

    async function downloadDocument(documentGroupId) {
        try {
            const response = await fetch('/api/samples/EmbeddedSenderWithFormAndFirstSigner', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    action: 'download-doc-group',
                    document_group_id: documentGroupId
                })
            });

            if (response.ok) {
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'completed_document.pdf';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            } else {
                alert('Error downloading document');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('An error occurred while downloading the document.');
        }
    }

    // Initialize pages
    document.addEventListener('DOMContentLoaded', () => {
        handlePages({
            'form-page': initFormPage,
            'signing-page': initSigningPage,
            'status-page': initStatusPage
        }, 'form-page');
    });

    // Notify parent application when workflow is complete
    window.addEventListener('load', () => {
        if (window.parent !== window) {
            parent.postMessage({type: "SAMPLE_APP_FINISHED"}, location.origin);
        }
    });
</script>
</body>
</html> 