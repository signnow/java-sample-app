<!doctype html>
<html class="no-js" lang="">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Sample App</title>
  <link href="/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/styles.css">
</head>

<body>
<div id="download-container">
  <img src="/img/sign-now.png" alt="signNow" />
  <div class="thank-you-message">
    <img src="/img/doc-completed.png" alt="signNow" class="mb-3" />
    <h4>Your Document Was Sent</h4>
    <p class="mb-4">You have successfully sent a document for signing. Once your document has been signed, you will receive a notification.</p>
    <button type="button" class="button-secondary" id="downloadButton">Download Document</button>
  </div>
</div>

<script>
  async function handlePages(pagesMap, defaultKey) {
    const fallbackKey = defaultKey || Object.keys(pagesMap)[0];
    const pageParam = new URLSearchParams(window.location.search).get('page') || fallbackKey;

    Object.keys(pagesMap).forEach(id => {
      const el = document.getElementById(id);
      if (el) el.style.display = 'none';
    });

    const handlerKey = pagesMap[pageParam] ? pageParam : fallbackKey;
    const handler = pagesMap[handlerKey];
    const el = document.getElementById(handlerKey);

    if (el) el.style.display = 'block';
    if (typeof handler === 'function') {
      await handler(el);
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    handlePages({
      'download-container': async (el) => {
        const downloadButton = document.getElementById('downloadButton');
        const urlParams = new URLSearchParams(window.location.search);
        const documentId = urlParams.get('document_id');

        downloadButton.addEventListener('click', async () => {
          try {
            const response = await fetch('/api/samples/EmbeddedSignerPatientIntakeForm', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ document_id: documentId })
            });

            if (!response.ok) throw new Error('Error fetching the file');

            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'completed_document.pdf';
            document.body.appendChild(a);
            a.click();
            a.remove();
            window.URL.revokeObjectURL(url);
          } catch (error) {
            console.error('Error downloading document', error);
            alert('Failed to download the document.');
          }
        });
      }
    }, 'download-container');
  });
</script>
</body>
</html>
